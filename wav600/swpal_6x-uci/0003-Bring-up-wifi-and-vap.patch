From 6f417e6c0ab8330d8b82f3f5d638dedf85533536 Mon Sep 17 00:00:00 2001
From: jialelux <jialex.lu@intel.com>
Date: Fri, 29 Jul 2022 04:12:04 +0000
Subject: [PATCH 3/5] Bring up wifi and vap

---
 .../etc/hotplug.d/ieee80211/mac80211.hotplug  | 37 +++++++++-
 .../scripts/etc/wave/scripts/common_utils.sh  |  6 +-
 files/scripts/lib/config/uci.sh               | 70 -------------------
 files/scripts/lib/netifd/wireless/mac80211.sh |  1 +
 4 files changed, 40 insertions(+), 74 deletions(-)

diff --git a/files/scripts/etc/hotplug.d/ieee80211/mac80211.hotplug b/files/scripts/etc/hotplug.d/ieee80211/mac80211.hotplug
index b865552..3f9469a 100644
--- a/files/scripts/etc/hotplug.d/ieee80211/mac80211.hotplug
+++ b/files/scripts/etc/hotplug.d/ieee80211/mac80211.hotplug
@@ -1,5 +1,40 @@
 #!/bin/sh
 
+UCI_WAV_DB=/etc/config/wireless
+WIFI_FACTORY_CMD=/opt/intel/wave/scripts/wave_factory_reset.sh
+
 [ "${ACTION}" = "add" ] && {
-	/sbin/wifi config
+	radios=`ls /proc/net/mtlk/| grep "wlan[0|2|4]"`
+	for i in $(seq 1 60); do
+		wlan2_ready=`echo $radios | grep wlan2`
+
+		if [ -z "$wlan2_ready" ]; then
+			sleep 1
+			radios=`ls /proc/net/mtlk/| grep "wlan[0|2|4]"`
+			continue
+		fi
+
+		break
+	done
+
+	if [ -z "$radios" ]; then
+		exit 1
+	fi
+
+	if [ -s "$UCI_WAV_DB" ]; then
+		db_radios=`cat ${UCI_WAV_DB} | grep "wlan[0|2|4]" | awk '{ print $3 }'`
+		db_radios=`echo $db_radios | sed $'s/\'//g'`
+		for radio in $radios; do
+			result=`echo $db_radios | grep "${radio}"`
+			if [ -z "$result" ]; then
+				echo "radio setting changed! UCI DB to be reset....." > /dev/console
+				${WIFI_FACTORY_CMD}
+				exit 0
+			fi
+		done
+
+		exit 0
+        fi
+
+	${WIFI_FACTORY_CMD}
 }
diff --git a/files/scripts/etc/wave/scripts/common_utils.sh b/files/scripts/etc/wave/scripts/common_utils.sh
index 853d588..68d84b3 100755
--- a/files/scripts/etc/wave/scripts/common_utils.sh
+++ b/files/scripts/etc/wave/scripts/common_utils.sh
@@ -175,14 +175,14 @@ update_mac_address()
 	fi
 
 	if [ "$OS_NAME" = "UGW" -o "$rdk_error" = "1" ]; then
-		if [ -e "/nvram/etc/wave/wav_base_mac" ]; then
-			source /nvram/etc/wave/wav_base_mac
+		if [ -e "/etc/wave/wav_base_mac" ]; then
+			source /etc/wave/wav_base_mac
 			board_mac=${board_mac##*HWaddr }
 			board_mac=${board_mac%% *}
 		elif [ "$rdk_error" = "1" ]; then
 			board_mac="00:50:F1:80:00:00"
 		else
-			board_mac=`ifconfig eth0_1`
+			board_mac=`ifconfig eth0`
 			board_mac=${board_mac##*HWaddr }
 			board_mac=${board_mac%% *}
 		fi
diff --git a/files/scripts/lib/config/uci.sh b/files/scripts/lib/config/uci.sh
index 18c0d9f..c865062 100644
--- a/files/scripts/lib/config/uci.sh
+++ b/files/scripts/lib/config/uci.sh
@@ -233,73 +233,3 @@ function wireless_apply() {
 	#in error situation run killall netifd
 }
 
-function main_func() {
-	if [ "$1" = "set" ]; then
-		input_tmp=`echo "$2" | awk '$1=$1' FS="." OFS=" "`
-		#The IFS changed only for this line (tested in bash)
-		dbFile=`echo "$input_tmp" | awk '{print $1}'`
-		input_tmp_num=`echo "$input_tmp" | awk '{print NF}'`
-		if [ "$input_tmp_num" = "2" ]; then                                   #uci set wireless.default_radio99='wifi-iface'
-			input_tmp_2=`echo "$input_tmp" | awk '{print $2}' | awk '$1=$1' FS="=" OFS=" "`
-			entity=`echo $input_tmp_2 | awk '{print $1}'`
-			input_tmp_3=`echo "$2" | awk '$1=$1' FS="=" OFS=" "`
-			iface=`echo $input_tmp_3 | awk '{print $2}'`
-			uci_add_vap ${dbFile} ${entity} ${iface}
-		else                    #uci set wireless.default_radio99.device=radio2 / uci set wireless.default_radio42.maxassoc=38
-			entity=`echo "$input_tmp" | awk '{print $2}'`
-			input_tmp_2=`echo "$input_tmp" | awk '{print $3}' | awk '$1=$1' FS="=" OFS=" "`
-			field=`echo "$input_tmp_2" | awk '{print $1}'`
-			value=${2#*=}
-			while [ "$3" != "" ]; do
-				value="$value $3"
-				shift
-			done
-			if [ "${field}" = "device" ]; then
-				uci_add_vap ${dbFile} ${entity} ${field} ${value}
-			else
-				uci_set ${dbFile} ${entity} ${field} ${value}
-			fi
-		fi
-	elif [[ "$1" = "delete" || "$1" = "del" ]]; then
-		input_tmp=`echo "$2" | awk '$1=$1' FS="." OFS=" "`
-		dbFile=`echo "$input_tmp" | awk '{print $1}'`
-		entity=`echo "$input_tmp" | awk '{print $2}'`
-		input_tmp_num=`echo "$input_tmp" | awk '{print NF}'`
-		if [ "$input_tmp_num" = "2" ]; then
-			uci_remove ${dbFile} ${entity}
-		elif [ "$input_tmp_num" = "3" ]; then
-			field=`echo "$input_tmp" | awk '{print $3}'`
-			uci_remove ${dbFile} ${entity} ${field}
-		else
-			input_tmp_2=`echo "$input_tmp" | awk '{print $3}' | awk '$1=$1' FS="=" OFS=" "`
-			field=`echo "$input_tmp_2" | awk '{print $1}'`
-			value=`echo "$input_tmp_2" | awk '{print $2}'`
-			uci_remove ${dbFile} ${entity} ${field}
-		fi
-
-	elif [[ "$1" = "add_list" || "$1" = "del_list" ]]; then
-		input_tmp=`echo "$2" | awk '$1=$1' FS="." OFS=" "`
-		dbFile=`echo "$input_tmp" | awk '{print $1}'`
-		entity=`echo "$input_tmp" | awk '{print $2}'`
-		input_tmp_2=`echo "$input_tmp" | awk '{print $3}' | awk '$1=$1' FS="=" OFS=" "`
-		field=`echo "$input_tmp_2" | awk '{print $1}'`
-		input_tmp_3=`echo "$2" | awk '$1=$1' FS="=" OFS=" "`
-		value=`echo $input_tmp_3 | awk '{$1=""}1'`
-		uci_${1} ${dbFile} ${entity} ${field} ${value}
-	elif [ "${1}" = "commit" ]; then
-		uci_commit ${2}
-	elif [ "${1}" = "apply" ]; then
-		wireless_apply
-		exit
-	elif [ "${1}" = "revert" ]; then
-		$UCI_APP revert wireless
-	else
-		uci_ret=`eval $UCI_APP $@`
-		echo $uci_ret
-	fi
-}
-
-if [ "/lib/config/uci.sh" = "$0" ]; then
-	input=`echo "${@/#-*/}" | awk -v RS=  '{$1=$1}1'`
-	main_func ${input}
-fi
diff --git a/files/scripts/lib/netifd/wireless/mac80211.sh b/files/scripts/lib/netifd/wireless/mac80211.sh
index 60b9121..1d677bc 100755
--- a/files/scripts/lib/netifd/wireless/mac80211.sh
+++ b/files/scripts/lib/netifd/wireless/mac80211.sh
@@ -989,6 +989,7 @@ mac80211_prepare_vif() {
 
 			[ -n "$hostapd_ctrl" ] || {
 				iw phy "$phy" interface add "$ifname" type __ap
+				ip link set dev "$ifname" address "$macaddr"
 				hostapd_ctrl="${hostapd_ctrl:-/var/run/hostapd/$ifname}"
 			}
 		;;
-- 
2.25.1

