From 2a36a0ba31efe58c2c2aaffb16fa859105097576 Mon Sep 17 00:00:00 2001
From: jialelux <jialex.lu@intel.com>
Date: Mon, 26 Sep 2022 04:08:24 +0000
Subject: [PATCH 2/2] swpal work on openwrt

---
 files/db/etc/wave/db/ugw/defaults             |  4 +-
 .../db/etc/wave/db/ugw/wireless_def_radio_24g |  3 +-
 .../db/etc/wave/db/ugw/wireless_def_radio_5g  |  3 +-
 files/db/etc/wave/db/ugw/wireless_def_vap_10  |  2 -
 files/db/etc/wave/db/ugw/wireless_def_vap_100 |  2 -
 files/db/etc/wave/db/ugw/wireless_def_vap_102 |  2 -
 files/db/etc/wave/db/ugw/wireless_def_vap_42  |  2 -
 .../etc/hotplug.d/ieee80211/mac80211.hotplug  | 40 +++++++++++
 .../scripts/etc/wave/scripts/common_utils.sh  |  6 +-
 .../etc/wave/scripts/wave_factory_reset.sh    |  5 ++
 files/scripts/lib/netifd/netifd-wireless.sh   | 68 +++++++++++++++++++
 files/scripts/lib/netifd/wireless/mac80211.sh |  4 +-
 files/scripts/lib/wifi/mac80211.sh            | 26 ++++++-
 files/scripts/sbin/wifi                       |  6 +-
 14 files changed, 153 insertions(+), 20 deletions(-)
 delete mode 100644 files/db/etc/wave/db/ugw/wireless_def_vap_10
 delete mode 100644 files/db/etc/wave/db/ugw/wireless_def_vap_100
 delete mode 100644 files/db/etc/wave/db/ugw/wireless_def_vap_102
 delete mode 100644 files/db/etc/wave/db/ugw/wireless_def_vap_42
 create mode 100644 files/scripts/etc/hotplug.d/ieee80211/mac80211.hotplug

diff --git a/files/db/etc/wave/db/ugw/defaults b/files/db/etc/wave/db/ugw/defaults
index 720ad26..f0378d1 100644
--- a/files/db/etc/wave/db/ugw/defaults
+++ b/files/db/etc/wave/db/ugw/defaults
@@ -1,5 +1,5 @@
 config wifi-db 'num_vaps'
-        option 24g '4'
-        option 5g '4'
+        option 24g '1'
+        option 5g '1'
         option 5g_zw_dfs '0'
         option 6g '1'
diff --git a/files/db/etc/wave/db/ugw/wireless_def_radio_24g b/files/db/etc/wave/db/ugw/wireless_def_radio_24g
index c37d601..c11ab53 100644
--- a/files/db/etc/wave/db/ugw/wireless_def_radio_24g
+++ b/files/db/etc/wave/db/ugw/wireless_def_radio_24g
@@ -2,7 +2,7 @@
 		option band '2.4GHz'
 		option channel 'auto'
 		option hwmode '11bgnax'
-		option htmode 'HT20'
+		option htmode 'HT40'
 		option disabled '0'
 		option country 'US'
 		option num_antennas '4'
@@ -10,3 +10,4 @@
 		option short_gi_20 '1'
 		option short_gi_40 '1'
 		option txpower '100'
+		option sDisableMasterVap '1'
diff --git a/files/db/etc/wave/db/ugw/wireless_def_radio_5g b/files/db/etc/wave/db/ugw/wireless_def_radio_5g
index 0930741..2a44ff5 100644
--- a/files/db/etc/wave/db/ugw/wireless_def_radio_5g
+++ b/files/db/etc/wave/db/ugw/wireless_def_radio_5g
@@ -2,7 +2,7 @@
 		option band '5GHz'
 		option channel 'auto'
 		option hwmode '11anacax'
-		option htmode 'VHT80'
+		option htmode 'VHT160'
 		option disabled '0'
 		option country 'US'
 		option num_antennas '4'
@@ -11,3 +11,4 @@
 		option short_gi_20 '1'
 		option short_gi_40 '1'
 		option txpower '100'
+		option sDisableMasterVap '1'
diff --git a/files/db/etc/wave/db/ugw/wireless_def_vap_10 b/files/db/etc/wave/db/ugw/wireless_def_vap_10
deleted file mode 100644
index 5d5bfc6..0000000
--- a/files/db/etc/wave/db/ugw/wireless_def_vap_10
+++ /dev/null
@@ -1,2 +0,0 @@
-        option wps_pushbutton '1'
-        option wps_rf_bands 'a'
diff --git a/files/db/etc/wave/db/ugw/wireless_def_vap_100 b/files/db/etc/wave/db/ugw/wireless_def_vap_100
deleted file mode 100644
index 2265b6f..0000000
--- a/files/db/etc/wave/db/ugw/wireless_def_vap_100
+++ /dev/null
@@ -1,2 +0,0 @@
-        option hidden '1'
-        option ssid 'dummy_ssid_100'
diff --git a/files/db/etc/wave/db/ugw/wireless_def_vap_102 b/files/db/etc/wave/db/ugw/wireless_def_vap_102
deleted file mode 100644
index f0d6c91..0000000
--- a/files/db/etc/wave/db/ugw/wireless_def_vap_102
+++ /dev/null
@@ -1,2 +0,0 @@
-        option hidden '1'
-        option ssid 'dummy_ssid_102'
diff --git a/files/db/etc/wave/db/ugw/wireless_def_vap_42 b/files/db/etc/wave/db/ugw/wireless_def_vap_42
deleted file mode 100644
index 4282cb3..0000000
--- a/files/db/etc/wave/db/ugw/wireless_def_vap_42
+++ /dev/null
@@ -1,2 +0,0 @@
-        option wps_pushbutton '1'
-        option wps_rf_bands 'g'
diff --git a/files/scripts/etc/hotplug.d/ieee80211/mac80211.hotplug b/files/scripts/etc/hotplug.d/ieee80211/mac80211.hotplug
new file mode 100644
index 0000000..e70e3b4
--- /dev/null
+++ b/files/scripts/etc/hotplug.d/ieee80211/mac80211.hotplug
@@ -0,0 +1,40 @@
+#!/bin/sh
+
+UCI_WAV_DB=/etc/config/wireless
+WIFI_FACTORY_CMD=/opt/intel/wave/scripts/wave_factory_reset.sh
+
+[ "${ACTION}" = "add" ] && {
+	radios=`ls /proc/net/mtlk/| grep "wlan[0|2|4]"`
+	for i in $(seq 1 60); do
+		wlan2_ready=`echo $radios | grep wlan2`
+
+		if [ -z "$wlan2_ready" ]; then
+			sleep 5
+			radios=`ls /proc/net/mtlk/| grep "wlan[0|2|4]"`
+			continue
+		fi
+
+		break
+	done
+
+	if [ -z "$radios" ]; then
+		exit 1
+	fi
+
+	if [ -s "$UCI_WAV_DB" ]; then
+		db_radios=`cat ${UCI_WAV_DB} | grep "wlan[0|2|4]" | awk '{ print $3 }'`
+		db_radios=`echo $db_radios | sed $'s/\'//g'`
+		for radio in $radios; do
+			result=`echo $db_radios | grep "${radio}"`
+			if [ -z "$result" ]; then
+				echo "radio setting changed! UCI DB to be reset....." > /dev/console
+				${WIFI_FACTORY_CMD}
+				exit 0
+			fi
+		done
+
+		exit 0
+        fi
+
+	${WIFI_FACTORY_CMD}
+}
diff --git a/files/scripts/etc/wave/scripts/common_utils.sh b/files/scripts/etc/wave/scripts/common_utils.sh
index 9512bc4..bb7ddc5 100755
--- a/files/scripts/etc/wave/scripts/common_utils.sh
+++ b/files/scripts/etc/wave/scripts/common_utils.sh
@@ -181,14 +181,14 @@ update_mac_address()
 	fi
 
 	if [ "$OS_NAME" = "UGW" -o "$rdk_error" = "1" ]; then
-		if [ -e "/nvram/etc/wave/wav_base_mac" ]; then
-			source /nvram/etc/wave/wav_base_mac
+		if [ -e "/etc/wave/wav_base_mac" ]; then
+			source /etc/wave/wav_base_mac
 			board_mac=${board_mac##*HWaddr }
 			board_mac=${board_mac%% *}
 		elif [ "$rdk_error" = "1" ]; then
 			board_mac="00:50:F1:80:00:00"
 		else
-			board_mac=`ifconfig eth0_1`
+			board_mac=`ifconfig eth0`
 			board_mac=${board_mac##*HWaddr }
 			board_mac=${board_mac%% *}
 		fi
diff --git a/files/scripts/etc/wave/scripts/wave_factory_reset.sh b/files/scripts/etc/wave/scripts/wave_factory_reset.sh
index efabf0a..eb2e15d 100755
--- a/files/scripts/etc/wave/scripts/wave_factory_reset.sh
+++ b/files/scripts/etc/wave/scripts/wave_factory_reset.sh
@@ -167,6 +167,11 @@ function full_reset(){
 		touch $UCI_DB_PATH/network
 	fi
 
+	if [ ! -f $ETC_CONFIG_WIRELESS_PATH ]; then
+                touch $ETC_CONFIG_WIRELESS_PATH
+        fi
+
+
 	clean_uci_cache
 
 	clean_uci_db
diff --git a/files/scripts/lib/netifd/netifd-wireless.sh b/files/scripts/lib/netifd/netifd-wireless.sh
index 4c646a9..42391ae 100644
--- a/files/scripts/lib/netifd/netifd-wireless.sh
+++ b/files/scripts/lib/netifd/netifd-wireless.sh
@@ -159,6 +159,26 @@ _wireless_add_vif() {
 	_wdev_notify
 }
 
+_wireless_add_vlan() {
+	local name="$1"; shift
+	local ifname="$1"; shift
+
+	_wdev_notify_init $CMD_SET_DATA "vlan" "$name"
+	json_add_string "ifname" "$ifname"
+	_wdev_add_variables "$@"
+	_wdev_notify
+}
+
+_wireless_add_vlan() {
+	local name="$1"; shift
+	local ifname="$1"; shift
+
+	_wdev_notify_init $CMD_SET_DATA "vlan" "$name"
+	json_add_string "ifname" "$ifname"
+	_wdev_add_variables "$@"
+	_wdev_notify
+}
+
 _wireless_set_up() {
 	_wdev_notify_init $CMD_UP
 	_wdev_notify
@@ -364,6 +384,35 @@ for_each_interface() {
 	json_select ..
 }
 
+for_each_vlan() {
+	local _w_vlans _w_vlan
+
+	json_get_keys _w_vlans vlans
+	json_select vlans
+	for _w_vlan in $_w_vlans; do
+		json_select "$_w_vlan"
+		json_select config
+		"$@" "$_w_vlan"
+		json_select ..
+		json_select ..
+	done
+	json_select ..
+}
+
+for_each_station() {
+	local _w_stas _w_sta
+
+	json_get_keys _w_stas stas
+	json_select stas
+	for _w_sta in $_w_stas; do
+		json_select "$_w_sta"
+		json_select config
+		"$@" "$_w_sta"
+		json_select ..
+		json_select ..
+	done
+	json_select ..
+}
 _wdev_common_device_config() {
 	config_add_string channel hwmode htmode noscan
 }
@@ -372,12 +421,21 @@ _wdev_common_iface_config() {
 	config_add_string mode ssid encryption dpp_support 'key:wpakey'
 }
 
+_wdev_common_vlan_config() {
+	config_add_string name vid iface
+}
+
+_wdev_common_station_config() {
+	config_add_string mac key vid iface
+}
+
 init_wireless_driver() {
 	name="$1"; shift
 	cmd="$1"; shift
 
 	logger -s "INFO: PID $$: $name $cmd $1 called"
 
+
 	case "$cmd" in
 		dump)
 			add_driver() {
@@ -397,6 +455,16 @@ init_wireless_driver() {
 				eval "drv_$1_init_iface_config"
 				json_close_array
 
+				json_add_array vlan
+				_wdev_common_vlan_config
+				eval "drv_$1_init_vlan_config"
+				json_close_array
+
+				json_add_array station
+				_wdev_common_station_config
+				eval "drv_$1_init_station_config"
+				json_close_array
+
 				json_dump
 			}
 		;;
diff --git a/files/scripts/lib/netifd/wireless/mac80211.sh b/files/scripts/lib/netifd/wireless/mac80211.sh
index ac2ec95..3a10f56 100755
--- a/files/scripts/lib/netifd/wireless/mac80211.sh
+++ b/files/scripts/lib/netifd/wireless/mac80211.sh
@@ -1154,6 +1154,7 @@ mac80211_prepare_vif() {
 
 			[ -n "$hostapd_ctrl" ] || {
 				iw phy "$phy" interface add "$ifname" type __ap
+				ip link set dev "$ifname" address "$macaddr"
 				hostapd_ctrl="${hostapd_ctrl:-/var/run/hostapd/$ifname}"
 			}
 		;;
@@ -2003,7 +2004,8 @@ setup_reconf() {
 				fi
 
 				if [ "$start_new" -eq 1 ]; then
-					/usr/sbin/hostapd -s$hostapd_log_level $global_ctrl_iface -P /var/run/$pid_file_name -B $hostapd_conf_file
+					#/usr/sbin/hostapd -s$hostapd_log_level $global_ctrl_iface -P /var/run/$pid_file_name -B $hostapd_conf_file
+					/usr/sbin/hostapd $global_ctrl_iface -P /var/run/$pid_file_name -B $hostapd_conf_file
 					ret="$?"
 
 					[ "$ret" != 0 ] && {
diff --git a/files/scripts/lib/wifi/mac80211.sh b/files/scripts/lib/wifi/mac80211.sh
index 39d0456..46eabe2 100644
--- a/files/scripts/lib/wifi/mac80211.sh
+++ b/files/scripts/lib/wifi/mac80211.sh
@@ -109,12 +109,34 @@ detect_mac80211() {
 			dev_id="set wireless.radio${devidx}.macaddr=$(cat /sys/class/ieee80211/${dev}/macaddress)"
 		fi
 
+		ssid="wave_2.4g"
+		band_ind="2.4GHz"
+		ifname_ind="wlan0"
+		if [ ${mode_band} == 'a' ]; then
+			ssid="wave_5g"
+			band_ind="5GHz"
+		fi
+		[ ${dev} = 'phy0' ] || ifname_ind="wlan2"
+		#WA for mac address
+		mac_addr=$(iw dev wlan0 info | grep addr)
+		mac_addr=${mac_addr#* }
+		if [ "${ifname_ind}" == "wlan2" ]; then
+			local machex=$( echo "$mac_addr" | tr -d ':' )
+			local macdec=$( printf "%d\n" 0x$machex )
+			macdec=$( expr $macdec + 1)
+			machex=$( printf "%12x\n" $macdec )
+			mac_addr=$( echo $machex | sed 's/\(..\)/\1:/g;s/:$//' )
+		fi
+		pre_addr=${mac_addr}
+		
 		uci -q batch <<-EOF
 			set wireless.radio${devidx}=wifi-device
 			set wireless.radio${devidx}.type=mac80211
 			set wireless.radio${devidx}.phy=${dev}
+			set wireless.radio${devidx}.country=CN
 			set wireless.radio${devidx}.channel=${channel}
 			set wireless.radio${devidx}.hwmode=11${mode_band}
+			set wireless.radio${devidx}.band=${band_ind}
 			${dev_id}
 			${ht_capab}
 			set wireless.radio${devidx}.disabled=1
@@ -123,7 +145,9 @@ detect_mac80211() {
 			set wireless.default_radio${devidx}.device=radio${devidx}
 			set wireless.default_radio${devidx}.network=lan
 			set wireless.default_radio${devidx}.mode=ap
-			set wireless.default_radio${devidx}.ssid=LEDE
+			set wireless.default_radio${devidx}.ssid=${ssid}
+			set wireless.default_radio${devidx}.ifname=${ifname_ind}
+			set wireless.default_radio${devidx}.macaddr=${mac_addr}
 			set wireless.default_radio${devidx}.encryption=none
 EOF
 		uci -q commit wireless
diff --git a/files/scripts/sbin/wifi b/files/scripts/sbin/wifi
index 392d3bd..a2939fb 100644
--- a/files/scripts/sbin/wifi
+++ b/files/scripts/sbin/wifi
@@ -16,7 +16,7 @@ EOF
 ubus_wifi_cmd() {
 	local cmd="$1"
 	local dev="$2"
-
+	
 	json_init
 	[ -n "$2" ] && json_add_string device "$2"
 	ubus call network.wireless "$1" "$(json_dump)"
@@ -152,8 +152,8 @@ wifi_detect_notice() {
 }
 
 wifi_config() {
-	[ ! -f $ETC_CONFIG_WIRELESS_PATH ] && touch &ETC_CONFIG_WIRELESS_PATH
-
+	[ ! -f /etc/config/wireless ] && touch /etc/config/wireless
+	
 	for driver in $DRIVERS; do (
 		if eval "type detect_$driver" 2>/dev/null >/dev/null; then
 			eval "detect_$driver" || echo "$driver: Detect failed" >&2
-- 
2.25.1

